<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard IA avec Mémoire</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="p-4">
    <h1>🤖 Dashboard IA avec Mémoire</h1>

    <div class="mb-3">
      <label for="memorySelect">Contexte :</label>
      <select id="memorySelect" class="form-select"></select>
    </div>

    <textarea
      id="chatBox"
      class="form-control mb-3"
      rows="8"
      readonly
    ></textarea>

    <div class="input-group mb-3">
      <input
        id="promptInput"
        type="text"
        class="form-control"
        placeholder="Écris ta question…"
      />
      <button id="sendBtn" class="btn btn-primary">Envoyer</button>
    </div>

    <script>
      let memName = "";

      async function loadMemories() {
        const res = await fetch("/memories");
        const arr = await res.json();
        const sel = document.getElementById("memorySelect");
        arr.forEach((c) => sel.add(new Option(c, c)));
        sel.onchange = loadHistory;
        sel.selectedIndex = 0;
        memName = sel.value;
        loadHistory();
      }

      async function loadHistory() {
        memName = document.getElementById("memorySelect").value;
        const res = await fetch(`/memories/${memName}`);
        const hist = await res.json();
        const cb = document.getElementById("chatBox");
        cb.value =
          hist
            .filter((m) => m.role === "user" || m.role === "assistant")
            .map((m) =>
              m.role === "user"
                ? `🗣️ Toi : ${m.content}`
                : `🤖 IA : ${m.content}`
            )
            .join("\n\n") + "\n\n";
        cb.scrollTop = cb.scrollHeight;
      }

      document.getElementById("sendBtn").onclick = async () => {
        const prompt = document.getElementById("promptInput").value.trim();
        if (!prompt) return;
        document.getElementById("promptInput").value = "";
        await fetch("/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt, memoryName: memName }),
        });
        loadHistory();
      };

      loadMemories();
    </script>
  </body>
</html>
