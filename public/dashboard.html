<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard IA TikTok</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="p-4">
    <h1>💬 Chat IA avec Mémoire</h1>

    <div class="mb-3">
      <label for="memorySelect">Choisir contexte :</label>
      <select id="memorySelect" class="form-select"></select>
    </div>

    <div class="mb-3">
      <textarea id="chatBox" class="form-control" rows="8" readonly></textarea>
    </div>

    <div class="input-group mb-3">
      <input
        id="promptInput"
        type="text"
        class="form-control"
        placeholder="Écris ta question…"
      />
      <button class="btn btn-primary" id="sendBtn">Envoyer</button>
    </div>

    <script>
      let selectedMem = "";

      async function loadMemories() {
        const res = await fetch("/memories");
        const arr = await res.json();
        const sel = document.getElementById("memorySelect");
        arr.forEach((c) => {
          const opt = document.createElement("option");
          opt.value = c;
          opt.text = c;
          sel.add(opt);
        });
        sel.addEventListener("change", loadHistory);
        sel.selectedIndex = 0;
        selectedMem = sel.value;
        loadHistory();
      }

      async function loadHistory() {
        selectedMem = document.getElementById("memorySelect").value;
        const res = await fetch(`/memories/${selectedMem}`);
        const hist = await res.json();
        const cb = document.getElementById("chatBox");
        cb.value =
          hist
            .map((m) =>
              m.role === "user"
                ? `🗣️ Toi : ${m.content}`
                : `🤖 IA : ${m.content}`
            )
            .join("\n\n") + "\n\n";
        cb.scrollTop = cb.scrollHeight;
      }

      document.getElementById("sendBtn").addEventListener("click", async () => {
        const prompt = document.getElementById("promptInput").value.trim();
        if (!prompt) return;
        document.getElementById("promptInput").value = "";
        await fetch("/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt, memoryName: selectedMem }),
        });
        await loadHistory();
      });

      loadMemories();
    </script>
  </body>
</html>
